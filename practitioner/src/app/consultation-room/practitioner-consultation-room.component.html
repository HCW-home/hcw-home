<div class="practitioner-consultation-room">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Connecting to consultation...</h3>
    <p>Setting up your video and audio</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">⚠️</div>
    <h3>Connection Error</h3>
    <p>{{ error }}</p>
    <div class="error-actions">
      <button class="btn btn-primary" (click)="retryInitialization()">
        🔄 Retry Connection
      </button>
      <button class="btn btn-secondary" (click)="leaveConsultation()">
        ← Back to Dashboard
      </button>
    </div>
  </div>

  <!-- Main Consultation Interface -->
  <div *ngIf="!isLoading && !error" class="consultation-interface">
    <!-- Modern Header -->
    <header class="modern-header">
      <div class="header-left">
        <h1 class="consultation-title">
          <span class="icon">🏥</span>
          Consultation Room
        </h1>
        <div class="status-pills">
          <span
            class="pill status-pill"
            [ngClass]="{
              active: consultationState?.sessionStatus === 'active',
              waiting: consultationState?.sessionStatus === 'waiting',
              connecting: consultationState?.sessionStatus === 'connecting'
            }"
          >
            <span class="pulse-dot"></span>
            {{ getSessionStatusText() }}
          </span>
          <span
            class="pill connection-pill"
            [ngClass]="{
              connected:
                connectionStatus.consultation &&
                connectionStatus.chat &&
                connectionStatus.media,
              partial:
                connectionStatus.consultation ||
                connectionStatus.chat ||
                connectionStatus.media,
              disconnected:
                !connectionStatus.consultation &&
                !connectionStatus.chat &&
                !connectionStatus.media
            }"
          >
            <span class="icon">{{ getConnectionIcon() }}</span>
            {{ getConnectionText() }}
          </span>
        </div>
      </div>

      <div class="header-center">
        <div class="timer" *ngIf="consultationDuration">
          <span class="icon">⏱️</span>
          <span class="time">{{ consultationDuration }}</span>
        </div>
      </div>

      <div class="header-right">
        <div class="participant-count-badge" *ngIf="participants.length > 0">
          <span class="icon">👥</span>
          <span class="count">{{ participants.length }}</span>
        </div>

        <button
          class="icon-button"
          (click)="toggleSidebar()"
          [class.active]="showSidebar"
          title="Toggle sidebar"
        >
          <span class="icon">{{ showSidebar ? "→" : "←" }}</span>
        </button>
      </div>
    </header>

    <!-- Main Content Grid -->
    <div class="main-content">
      <!-- Video Stage Area -->
      <div class="video-stage">
        <!-- Empty State / Placeholder -->
        <div
          *ngIf="
            !isVideoEnabled &&
            !isScreenSharing &&
            !consultationState?.patientPresent
          "
          class="empty-state"
        >
          <div class="empty-state-content">
            <div class="camera-preview-placeholder">
              <div class="placeholder-icon">📹</div>
              <h3>Your camera is off</h3>
              <p>Others in the meeting won't be able to see you</p>
              <button class="cta-button primary" (click)="toggleVideo()">
                <span class="icon">📹</span>
                Turn on Camera
              </button>
            </div>

            <div class="quick-actions">
              <button class="action-card" (click)="toggleAudio()">
                <span class="icon">🎤</span>
                <span class="label">{{
                  isAudioEnabled ? "Mute" : "Unmute"
                }}</span>
              </button>

              <button class="action-card" (click)="startScreenShare()">
                <span class="icon">🖥️</span>
                <span class="label">Share Screen</span>
              </button>

              <button
                class="action-card"
                (click)="showAddParticipantModal = true"
              >
                <span class="icon">➕</span>
                <span class="label">Add Participant</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Active Video Grid -->
        <div
          *ngIf="
            isVideoEnabled ||
            consultationState?.patientPresent ||
            isScreenSharing
          "
          class="video-grid"
          [ngClass]="{
            'one-participant': getTotalParticipantsWithVideo() === 1,
            'two-participants': getTotalParticipantsWithVideo() === 2,
            'three-plus': getTotalParticipantsWithVideo() >= 3
          }"
        >
          <!-- Local Video (Practitioner) -->
          <div *ngIf="isVideoEnabled" class="video-tile local-video">
            <video
              #videoElement
              autoplay
              muted
              playsinline
              class="video-element"
            ></video>
            <div class="video-overlay">
              <span class="participant-label">
                <span class="icon">👨‍⚕️</span>
                You (Dr.)
              </span>
              <div class="quick-controls">
                <button
                  class="mini-control"
                  (click)="toggleVideo()"
                  [class.active]="isVideoEnabled"
                >
                  {{ isVideoEnabled ? "📹" : "🚫" }}
                </button>
                <button
                  class="mini-control"
                  (click)="toggleAudio()"
                  [class.active]="isAudioEnabled"
                >
                  {{ isAudioEnabled ? "🎤" : "🔇" }}
                </button>
              </div>
            </div>
          </div>

          <!-- Patient Video -->
          <div
            *ngIf="consultationState?.patientPresent"
            class="video-tile remote-video"
          >
            <div class="patient-placeholder">
              <div class="avatar-large">👤</div>
              <h4>{{ consultationState?.patientName || "Patient" }}</h4>
              <p
                *ngIf="consultationState?.patientLanguage"
                class="language-tag"
              >
                🌐 {{ consultationState?.patientLanguage }}
              </p>
            </div>
            <div class="video-overlay">
              <span class="participant-label">
                <span class="icon">🤝</span>
                {{ consultationState?.patientName }}
              </span>
            </div>
          </div>

          <!-- Screen Share -->
          <div *ngIf="isScreenSharing" class="video-tile screen-share">
            <div class="screen-share-placeholder">
              <span class="icon">🖥️</span>
              <p>Your screen is being shared</p>
            </div>
            <div class="video-overlay">
              <span class="participant-label">
                <span class="icon">🖥️</span>
                Screen Share
              </span>
              <button class="stop-share-btn" (click)="stopScreenShare()">
                Stop Sharing
              </button>
            </div>
          </div>

          <!-- Waiting for Patient -->
          <div
            *ngIf="
              !consultationState?.patientPresent &&
              consultationState?.sessionStatus === 'active'
            "
            class="video-tile waiting-tile"
          >
            <div class="waiting-content">
              <div class="waiting-animation">
                <div class="pulse-ring"></div>
                <div class="icon">⏳</div>
              </div>
              <h4>Waiting for patient</h4>
              <p>The patient will appear here when they join</p>
            </div>
          </div>
        </div>

        <!-- Floating Media Controls -->
        <div class="floating-controls">
          <div class="controls-container">
            <button
              class="control-button"
              [class.active]="isAudioEnabled"
              (click)="toggleAudio()"
              [title]="isAudioEnabled ? 'Mute (M)' : 'Unmute (M)'"
            >
              <span class="control-icon">{{
                isAudioEnabled ? "🎤" : "🔇"
              }}</span>
              <span class="control-label">{{
                isAudioEnabled ? "Mute" : "Unmuted"
              }}</span>
            </button>

            <button
              class="control-button"
              [class.active]="isVideoEnabled"
              (click)="toggleVideo()"
              [title]="
                isVideoEnabled ? 'Turn off camera (V)' : 'Turn on camera (V)'
              "
            >
              <span class="control-icon">{{
                isVideoEnabled ? "📹" : "🚫📹"
              }}</span>
              <span class="control-label">{{
                isVideoEnabled ? "Stop Video" : "Start Video"
              }}</span>
            </button>

            <button
              class="control-button"
              [class.active]="isScreenSharing"
              (click)="isScreenSharing ? stopScreenShare() : startScreenShare()"
              title="Share screen"
            >
              <span class="control-icon">🖥️</span>
              <span class="control-label">{{
                isScreenSharing ? "Stop Sharing" : "Share Screen"
              }}</span>
            </button>

            <button
              class="control-button"
              (click)="showChat = !showChat"
              [class.active]="showChat"
              title="Toggle chat"
            >
              <span class="control-icon">💬</span>
              <span class="control-label">Chat</span>
              <span *ngIf="unreadMessageCount > 0" class="notification-badge">{{
                unreadMessageCount
              }}</span>
            </button>

            <button
              class="control-button settings-btn"
              (click)="showSettingsMenu = !showSettingsMenu"
              title="Settings"
            >
              <span class="control-icon">⚙️</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <aside
        class="sidebar"
        [class.collapsed]="!showSidebar"
        [class.mobile-open]="showSidebar && isMobileView"
      >
        <!-- Sidebar Tabs -->
        <div class="sidebar-tabs">
          <button
            class="tab-button"
            [class.active]="activeSidebarTab === 'participants'"
            (click)="activeSidebarTab = 'participants'"
          >
            <span class="icon">👥</span>
            <span class="label">Participants</span>
            <span class="count">({{ participants.length }})</span>
          </button>

          <button
            class="tab-button"
            [class.active]="activeSidebarTab === 'chat'"
            (click)="activeSidebarTab = 'chat'"
          >
            <span class="icon">💬</span>
            <span class="label">Chat</span>
            <span *ngIf="unreadMessageCount > 0" class="count notification"
              >({{ unreadMessageCount }})</span
            >
          </button>

          <button
            class="tab-button"
            [class.active]="activeSidebarTab === 'activity'"
            (click)="activeSidebarTab = 'activity'"
          >
            <span class="icon">📊</span>
            <span class="label">Activity</span>
          </button>
        </div>

        <!-- Participants Tab -->
        <div
          *ngIf="activeSidebarTab === 'participants'"
          class="sidebar-content participants-content"
        >
          <div class="section-header">
            <h3>In this meeting</h3>
            <button class="add-button" (click)="showAddParticipantModal = true">
              <span class="icon">➕</span>
              Add People
            </button>
          </div>

          <div class="participants-list">
            <!-- Current User -->
            <div class="participant-item me">
              <div class="participant-avatar">
                <span class="avatar-icon">👨‍⚕️</span>
              </div>
              <div class="participant-info">
                <div class="participant-name">You</div>
                <div class="participant-role">Practitioner • Host</div>
              </div>
              <div class="participant-status">
                <span
                  *ngIf="isVideoEnabled"
                  class="status-icon video-on"
                  title="Camera on"
                  >📹</span
                >
                <span
                  *ngIf="!isVideoEnabled"
                  class="status-icon video-off"
                  title="Camera off"
                  >🚫📹</span
                >
                <span
                  *ngIf="isAudioEnabled"
                  class="status-icon audio-on"
                  title="Microphone on"
                  >🎤</span
                >
                <span
                  *ngIf="!isAudioEnabled"
                  class="status-icon audio-off"
                  title="Muted"
                  >🔇</span
                >
              </div>
            </div>

            <!-- Other Participants -->
            <div
              *ngFor="let participant of participants"
              class="participant-item"
            >
              <div class="participant-avatar">
                <span class="avatar-icon">{{
                  getParticipantIcon(participant.role)
                }}</span>
              </div>
              <div class="participant-info">
                <div class="participant-name">
                  {{ participant.firstName }} {{ participant.lastName }}
                </div>
                <div class="participant-role">
                  {{ formatRole(participant.role) }}
                </div>
              </div>
              <div class="participant-status">
                <span
                  class="connection-indicator"
                  [ngClass]="{
                    connected: participant.isActive,
                    disconnected: !participant.isActive
                  }"
                ></span>
              </div>
            </div>

            <!-- Empty State -->
            <div *ngIf="participants.length === 0" class="empty-participants">
              <div class="empty-icon">👥</div>
              <p>No other participants yet</p>
              <button
                class="link-button"
                (click)="showAddParticipantModal = true"
              >
                Invite people to join
              </button>
            </div>
          </div>
        </div>

        <!-- Chat Tab -->
        <div
          *ngIf="activeSidebarTab === 'chat'"
          class="sidebar-content chat-content"
        >
          <app-practitioner-chat
            [messages]="chatMessages"
            [consultationId]="consultationId"
            [practitionerId]="practitionerId"
            [practitionerName]="'Dr. Practitioner'"
            [canLoadMore]="canLoadMoreMessages()"
            (sendMessage)="sendChatMessage($event)"
            (loadMoreMessages)="loadMoreChatMessages()"
          ></app-practitioner-chat>
        </div>

        <!-- Activity Tab -->
        <div
          *ngIf="activeSidebarTab === 'activity'"
          class="sidebar-content activity-content"
        >
          <div class="section-header">
            <h3>Activity Log</h3>
          </div>

          <div class="activity-list">
            <div
              *ngFor="let event of events.slice(0, 20)"
              class="activity-item"
              [ngClass]="'severity-' + event.severity"
            >
              <div class="activity-icon">{{ getEventIcon(event.type) }}</div>
              <div class="activity-details">
                <div class="activity-title">{{ event.title }}</div>
                <div class="activity-description">{{ event.description }}</div>
                <div class="activity-time">
                  {{ formatTimestamp(event.timestamp) }}
                </div>
              </div>
            </div>

            <div *ngIf="events.length === 0" class="empty-activity">
              <div class="empty-icon">📊</div>
              <p>No activity yet</p>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Waiting Room Alert -->
    <div
      *ngIf="
        showWaitingRoomAlert &&
        (consultationState?.waitingRoomStatus?.hasWaitingPatients ?? false)
      "
      class="waiting-room-alert"
    >
      <div class="alert-content">
        <div class="alert-icon">🚪</div>
        <div class="alert-text">
          <strong>
            {{ consultationState?.waitingRoomStatus?.waitingCount ?? 0 }}
            patient(s) waiting
          </strong>
          <p>Someone is in the waiting room</p>
        </div>
        <div class="alert-actions">
          <button class="btn-primary" (click)="admitPatient()">Admit</button>
          <button class="btn-ghost" (click)="showWaitingRoomAlert = false">
            Dismiss
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Participant Modal -->
<div
  *ngIf="showAddParticipantModal"
  class="modal-overlay"
  (click)="showAddParticipantModal = false"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Participant</h3>
      <button class="close-button" (click)="showAddParticipantModal = false">
        ×
      </button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="addPendingParticipant()" class="participant-form">
        <div class="form-group">
          <label>Role</label>
          <select
            [(ngModel)]="pendingParticipant.role"
            name="role"
            required
            class="form-control"
          >
            <option value="EXPERT">Medical Expert</option>
            <option value="GUEST">Guest/Family</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input
              type="text"
              [(ngModel)]="pendingParticipant.firstName"
              name="firstName"
              required
              class="form-control"
              placeholder="John"
            />
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input
              type="text"
              [(ngModel)]="pendingParticipant.lastName"
              name="lastName"
              class="form-control"
              placeholder="Doe"
            />
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input
            type="email"
            [(ngModel)]="pendingParticipant.email"
            name="email"
            required
            class="form-control"
            placeholder="john.doe@example.com"
          />
        </div>

        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea
            [(ngModel)]="pendingParticipant.notes"
            name="notes"
            class="form-control"
            rows="3"
            placeholder="Any additional information..."
          ></textarea>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="showAddParticipantModal = false"
          >
            Cancel
          </button>
          <button type="submit" class="btn-primary">Send Invitation</button>
        </div>
      </form>
    </div>
  </div>
</div>
